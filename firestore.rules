/**
 * @description This ruleset enforces a strict user-ownership model for designs and a public-read, owner-write model for design templates.
 * @dataStructure
 *   - All user data and designs are nested under /users/{userId}.
 *   - Designs are stored in a subcollection /users/{userId}/designs/{designId}.
 *   - Design templates are stored in the top-level collection /design-templates/{templateId}.
 * @keySecurityDecisions
 *   - Users can only access their own user document.
 *   - Users can only access designs they own.
 *   - Design templates are publicly readable but only writable by the owner (not implemented in this version).
 * @denormalizationForAuthorization
 *   - Each design document has a `userId` field that is used to enforce ownership.
 * @structuralSegregation
 *   - Private user data and public template data are stored in separate collections to avoid complex read rules.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their own document.
     * @allow (get) User with UID 'user123' can read their own document.
     * @allow (update) User with UID 'user123' can update their own document.
     * @allow (delete) User with UID 'user123' can delete their own document.
     * @deny (get) User with UID 'user456' cannot read user document with ID 'user123'.
     * @deny (create) User with UID 'user456' cannot create a user document with ID 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Function to check if the requested user ID matches the authenticated user ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      // Allow a user to create their own document if the UID matches
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;

      // Allow a user to get their own document if signed in and the UID matches
      allow get: if isSignedIn() && isOwner(userId);

      // Allow a user to update their own document if signed in and the UID matches
      allow update: if isSignedIn() && isOwner(userId) && request.resource.data.id == resource.data.id;

      // Allow a user to delete their own document if signed in and the UID matches
      allow delete: if isSignedIn() && isOwner(userId) && resource != null;

      // List operation
      allow list: if false;
    }

    /**
     * @description Controls access to design documents nested under a user.
     * @path /users/{userId}/designs/{designId}
     * @allow (create) User with UID 'user123' can create a design under their ID.
     * @allow (get) User with UID 'user123' can read a design under their ID.
     * @allow (update) User with UID 'user123' can update a design under their ID.
     * @allow (delete) User with UID 'user123' can delete a design under their ID.
     * @deny (create) User with UID 'user456' cannot create a design under user 'user123'.
     * @deny (get) User with UID 'user456' cannot read a design under user 'user123'.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/designs/{designId} {
      // Function to check if the user is signed in
      function isSignedIn() {
        return request.auth != null;
      }

      // Function to check if the requested user ID matches the authenticated user ID
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      
       function isExistingOwner(userId) {
            return isSignedIn() && isOwner(userId) && resource != null;
        }

      // Allow a user to create a design under their own user ID
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;

      // Allow a user to get a design under their own user ID
      allow get: if isSignedIn() && isOwner(userId);

      // Allow a user to update a design under their own user ID
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;

      // Allow a user to delete a design under their own user ID
      allow delete: if isExistingOwner(userId);

      // List operation
      allow list: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to design template documents.
     * @path /design-templates/{templateId}
     * @allow (get) Any user can read design templates.
     * @deny (create) No user can create design templates without specific authorization (TODO).
     * @deny (update) No user can update design templates without specific authorization (TODO).
     * @deny (delete) No user can delete design templates without specific authorization (TODO).
     * @principle Allows public read access but restricts write access to authorized users.
     */
    match /design-templates/{templateId} {
      // Allow anyone to read design templates
      allow get, list: if true;

      // Deny all write operations.  Templates would need an 'ownerId' field to implement secure ownership.
      allow create, update, delete: if false;
    }
  }
}